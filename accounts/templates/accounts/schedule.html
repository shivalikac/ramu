{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1>Meal Planning Calendar</h1>
    <p>Use this calendar to plan your meals.</p>

    <!-- Calendar Display -->
    <div id="calendar"></div>
    <button id="add-manual-event-btn" class="btn btn-primary mt-3">Add Meal Manually</button>
    <button class="btn btn-primary mt-3" id="add-grocery-shopping-btn">Add Grocery Shopping</button>
</div>
<!-- Modal for Adding Manual Meal or Grocery Shopping -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Add Event to Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="calendar-date" class="form-label">Select a Date</label>
                        <input type="date" class="form-control" id="calendar-date">
                    </div>
                    <div class="mb-3" id="meal-type-select" style="display: none;">
                        <label for="meal-type" class="form-label">Meal Type</label>
                        <select class="form-select" id="meal-type">
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                    <div class="mb-3" id="event-title-input" style="display: none;">
                        <label for="event-title" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="event-title" placeholder="Enter dish name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event-btn">Add to Calendar</button>
            </div>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        editable: true,
        selectable: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '/fetch_calendar_events/',

        eventContent: function (info) {
            const { title, extendedProps, id } = info.event;
            const { meal_type } = extendedProps;

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            container.style.padding = '10px';
            container.style.borderRadius = '8px';

            // Set colors for different event types
            if (title === "Grocery Shopping!") {
                container.style.backgroundColor = '#FFD700'; // Gold for grocery shopping
                container.style.color = '#000'; // Dark text for contrast
            } else {
                container.style.backgroundColor = meal_type === 'lunch' ? '#87CEEB' : '#FFB6C1'; // Blue for lunch, pink for dinner
                container.style.color = '#fff'; // White text
            }

            // Meal Type or Event Type Display
            const eventTypeEl = document.createElement('div');
            eventTypeEl.textContent = title === "Grocery Shopping!" 
                ? "Grocery Shopping" 
                : `${meal_type.charAt(0).toUpperCase() + meal_type.slice(1)}:`;
            eventTypeEl.style.fontWeight = 'bold';
            container.appendChild(eventTypeEl);

            // Event Title with Link to Notes Page
            const titleEl = document.createElement('a');
            titleEl.textContent = title;
            titleEl.href = title === "Grocery Shopping!" 
                ? `/grocery_notes/${id}/` 
                : `/recipe_notes/${id}/`;
            titleEl.target = '_blank'; // Open in a new tab
            titleEl.style.color = '#fff';
            titleEl.style.textDecoration = 'underline';
            titleEl.style.marginTop = '4px';
            container.appendChild(titleEl);

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn btn-sm btn-danger mt-2';
            deleteBtn.onclick = () => deleteEvent(id);
            container.appendChild(deleteBtn);

            return { domNodes: [container] };
        }
    });

    calendar.render();

    // Delete Event Function
    function deleteEvent(eventId) {
        console.log("Event ID received in deleteEvent:", eventId);

        if (!eventId) {
            alert("Event ID is missing. Unable to delete the event.");
            return;
        }

        fetch("{% url 'delete_calendar_event' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ event_id: eventId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert(data.message);
                calendar.refetchEvents(); // Refresh the calendar to update events
            } else {
                alert(data.message || "Error deleting event.");
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Add Grocery Shopping Event
    // document.getElementById('add-grocery-shopping-btn').addEventListener('click', function () {
    //     const date = prompt('Enter the date for grocery shopping (YYYY-MM-DD):');
    //     if (!date) return;

    //     fetch("{% url 'add_grocery_shopping_event' %}", {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json',
    //             'X-CSRFToken': '{{ csrf_token }}'
    //         },
    //         body: JSON.stringify({ date: date })
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.status === "success") {
    //             alert(data.message);
    //             calendar.refetchEvents(); // Refresh events
    //         } else {
    //             alert(data.message);
    //         }
    //     })
    //     .catch(error => console.error('Error:', error));
    // });


    // Add Grocery Shopping Event Listener
    document.getElementById('add-grocery-shopping-btn').addEventListener('click', function () {
        // Reset modal fields
        document.getElementById('calendar-date').value = '';
        document.getElementById('meal-type-select').style.display = 'none';
        document.getElementById('event-title-input').style.display = 'none';

        // Show the modal
        const calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        calendarModal.show();

        // Handle saving the grocery shopping event
        document.getElementById('save-event-btn').onclick = function () {
            const date = document.getElementById('calendar-date').value;

            if (!date) {
                alert("Please select a date.");
                return;
            }

            fetch("{% url 'add_grocery_shopping_event' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ date })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(data.message);
                    calendar.refetchEvents(); // Refresh the calendar
                    calendarModal.hide();
                } else {
                    alert(data.message || "Error adding event.");
                }
            })
            .catch(error => console.error('Error:', error));
        };
    });

    // Add Manual Meal Event
    // document.getElementById('add-manual-event-btn').addEventListener('click', function () {
    //     const title = prompt('Enter the dish name:');
    //     if (!title) return;

    //     const date = prompt('Enter the date (YYYY-MM-DD):');
    //     if (!date) return;

    //     const mealType = prompt('Is this for lunch or dinner? (Type "lunch" or "dinner")').toLowerCase();
    //     if (!['lunch', 'dinner'].includes(mealType)) {
    //         alert('Invalid meal type. Please type "lunch" or "dinner".');
    //         return;
    //     }

    //     fetch("{% url 'add_manual_calendar_event' %}", {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json',
    //             'X-CSRFToken': '{{ csrf_token }}'
    //         },
    //         body: JSON.stringify({ title, date, meal_type: mealType })
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.status === "success") {
    //             alert(data.message);
    //             calendar.refetchEvents(); // Refresh events
    //         } else {
    //             alert(data.message);
    //         }
    //     })
    //     .catch(error => console.error('Error:', error));
    // });


    // Add Manual Meal Event Listener
    document.getElementById('add-manual-event-btn').addEventListener('click', function () {
        // Reset modal fields
        document.getElementById('calendar-date').value = '';
        document.getElementById('meal-type-select').style.display = 'block';
        document.getElementById('event-title-input').style.display = 'block';

        // Show the modal
        const calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        calendarModal.show();

        // Handle saving the manual event
        document.getElementById('save-event-btn').onclick = function () {
            const date = document.getElementById('calendar-date').value;
            const mealType = document.getElementById('meal-type').value;
            const title = document.getElementById('event-title').value;

            if (!date || !mealType || !title) {
                alert("Please fill all fields.");
                return;
            }

            fetch("{% url 'add_manual_calendar_event' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ title, date, meal_type: mealType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(data.message);
                    calendar.refetchEvents(); // Refresh the calendar
                    calendarModal.hide();
                } else {
                    alert(data.message || "Error adding event.");
                }
            })
            .catch(error => console.error('Error:', error));
        };
    });

});


</script>
<style>
    /* Style for calendar events */
    .fc-event {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .fc-event div:first-child {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .fc-event div:last-child {
        font-size: 12px;
        color: #333; /* Neutral text color for readability */
    }

    /* Add hover effects for better user experience */
    .fc-event:hover {
        background-color: rgba(0, 0, 0, 0.1); /* Slightly darken the background on hover */
        cursor: pointer;
    }
</style>

{% endblock %}
