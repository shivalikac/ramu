{% extends 'base.html' %}
<!-- Extends the base template to include common structure -->

{% block content %}
<div class="container mt-5">
    <h1>Meal Planning Calendar</h1>

    <!-- Calendar display section -->
    <div id="calendar"></div>

    <!-- Button to add events manually -->
    <button id="add-manual-event-btn" class="btn btn-primary mt-3">Add Meal Manually</button>
    <button class="btn btn-primary mt-3" id="add-grocery-shopping-btn">Add Grocery Shopping</button>
</div>

<!-- Modal for adding manual meal or grocery shopping events -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Add Event to Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="calendar-date" class="form-label">Select a Date</label>
                        <input type="date" class="form-control" id="calendar-date">
                    </div>
                    <div class="mb-3" id="meal-type-select" style="display: none;">
                        <label for="meal-type" class="form-label">Meal Type</label>
                        <select class="form-select" id="meal-type">
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                    <div class="mb-3" id="event-title-input" style="display: none;">
                        <label for="event-title" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="event-title" placeholder="Enter dish name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event-btn">Add to Calendar</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for calendar and event handling -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize FullCalendar in the "calendar" div
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',  // Default view is the month grid
            editable: true, 
            selectable: true,  
            headerToolbar: { 
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/fetch_calendar_events/',

            // Customize event content
            eventContent: function (info) {
                const { title, extendedProps, id } = info.event;
                const { meal_type } = extendedProps;

                // Create a container for the event
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.padding = '10px';
                container.style.borderRadius = '8px';
                container.style.width = '100%';
                container.style.height = '100%';

                // Set colors for different event types
                if (title === "Grocery Shopping!") {
                    container.style.backgroundColor = '#F9C74F'; // Gold for grocery shopping
                    container.style.color = '#B8860B'; // Dark text for contrast
                } else if (meal_type === "lunch" ){
                    container.style.backgroundColor = '#87CEEB'; // Blue for lunch, pink for dinner
                    container.style.color = '#000080'; // White text
                } else if (meal_type === "dinner"){
                    container.style.backgroundColor = '#FFB6C1'; // Blue for lunch, pink for dinner
                    container.style.color = '#800000'; // White text
                }

                // Add event type or meal type
                const eventTypeEl = document.createElement('div');
                eventTypeEl.textContent = title === "Grocery Shopping!" 
                    ? "Grocery Shopping" 
                    : `${meal_type.charAt(0).toUpperCase() + meal_type.slice(1)}:`;
                eventTypeEl.style.fontWeight = 'bold';
                container.appendChild(eventTypeEl);

                // Event Title with Link to Notes Page
                const titleEl = document.createElement('a');
                titleEl.textContent = title;
                titleEl.href = title === "Grocery Shopping!" 
                    ? `/grocery_notes/${id}/` 
                    : `/recipe_notes/${id}/`;
                titleEl.target = '_blank'; // Open in a new tab
                titleEl.style.color = '#fff';
                titleEl.style.textDecoration = 'underline';
                titleEl.style.marginTop = '4px';
                container.appendChild(titleEl);

                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'btn btn-sm btn-danger mt-2';
                deleteBtn.onclick = () => deleteEvent(id);
                container.appendChild(deleteBtn);

                return { domNodes: [container] };
            }
        });

        calendar.render();

        // Delete an event from the calendar
        function deleteEvent(eventId) {
            if (!eventId) {
                alert("Event ID is missing. Unable to delete the event.");
                return;
            }

            fetch("{% url 'delete_calendar_event' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(data.message);
                    calendar.refetchEvents();
                } else {
                    alert(data.message || "Error deleting event.");
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

</script>

<style>
    /* Style for calendar events */
    /* Remove the default background and fit events to the entire block */
    .fc-event {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        background: none !important; 
        border: none !important;
        /* Fit the full date block */
        width: 100%; 
        height: 100%;
        padding: 0; 
        box-shadow: none;
    }

    /* Adjust text inside the event */
    .fc-event div:first-child {
        font-size: 16px; /* Increase font size */
        font-weight: bold;
        //color: #000; /* Black text for readability */
        text-align: center;
        width: 100%; /* Ensure full width */
    }

    .fc-event div:last-child {
        font-size: 14px;
        color: #333; /* Neutral text color for readability */
    }

    /* Add hover effects for better user experience */
    .fc-event:hover {
        background-color: rgba(0, 0, 0, 0.1); /* Slightly darken the background on hover */
        cursor: pointer;
    }
    body {
        font-family: 'Lato', sans-serif; 
    }
    button, input, select, textarea {
        font-family: 'Lato', sans-serif; 
    }
</style>

{% endblock %}
