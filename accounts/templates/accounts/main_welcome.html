{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1>Welcome, {{ user.username }}!</h1>

    <!-- Pantry Section -->
    <h3>Your Pantry</h3>
    <div class="mb-3">
        <label for="pantry" class="form-label">Add Pantry Item</label>
        <input type="text" class="form-control" id="pantry" placeholder="Enter pantry item name">
        <input type="number" class="form-control mt-2" id="pantry_quantity" placeholder="Quantity" value="1">
    </div>
    <ul id="pantry-list" class="list-group">
        {% for item in pantry_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                {{ item.item_name }} ({{ item.quantity }})
                <button class="btn btn-danger btn-sm" onclick="deletePantryItem({{ item.id }})">Delete</button>
            </li>
        {% empty %}
            <li class="list-group-item" id="no-pantry">No pantry items added.</li>
        {% endfor %}
    </ul>

    <!-- Utensil Section -->
    <h3>Your Utensils</h3>
    <div class="mb-3">
        <label for="utensil" class="form-label">Add Utensil</label>
        <input type="text" class="form-control" id="utensil" placeholder="Enter utensil name">
        <input type="number" class="form-control mt-2" id="utensil_quantity" placeholder="Quantity" value="1">
    </div>
    <ul id="utensil-list" class="list-group">
        {% for utensil in utensil_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ utensil.id }}">
                {{ utensil.utensil_name }} ({{ utensil.quantity }})
                <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem({{ utensil.id }})">Delete</button>
            </li>
        {% empty %}
            <li class="list-group-item" id="no-utensils">No utensils added.</li>
        {% endfor %}
    </ul>

    <!-- Filters for Recipes -->
    <div class="mb-3">
        <label for="cooking-time" class="form-label">Maximum Cooking Time (in minutes)</label>
        <input type="number" class="form-control" id="cooking-time" placeholder="Enter time (e.g., 30)" min="1">
    </div>
    <div class="mb-3">
        <label for="recipe-count" class="form-label">Number of Recipe Suggestions</label>
        <input type="number" class="form-control" id="recipe-count" value="5" min="1" max="10">
    </div>
    <div class="mb-3">
        <label for="cuisine-select" class="form-label">Select a Cuisine</label>
        <select class="form-select" id="cuisine-select">
            <option value="">-- Select Cuisine --</option>
            <option value="African">African</option>
            <option value="American">American</option>
            <option value="British">British</option>
            <option value="Cajun">Cajun</option>
            <option value="Caribbean">Caribbean</option>
            <option value="Chinese">Chinese</option>
            <option value="Eastern European">Eastern European</option>
            <option value="European">European</option>
            <option value="French">French</option>
            <option value="German">German</option>
            <option value="Greek">Greek</option>
            <option value="Indian">Indian</option>
            <option value="Irish">Irish</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Jewish">Jewish</option>
            <option value="Korean">Korean</option>
            <option value="Latin American">Latin American</option>
            <option value="Mediterranean">Mediterranean</option>
            <option value="Mexican">Mexican</option>
            <option value="Middle Eastern">Middle Eastern</option>
            <option value="Nordic">Nordic</option>
            <option value="Southern">Southern</option>
            <option value="Spanish">Spanish</option>
            <option value="Thai">Thai</option>
            <option value="Vietnamese">Vietnamese</option>
        </select>
    </div>

    <button class="btn btn-primary mt-4" id="generate-recipe-btn">Generate Recipe</button>

    <!-- Recipe Display -->
    <div id="recipe-display" class="mt-4">
        <h3>Suggested Recipes</h3>
        <ul id="recipe-list" class="list-group"></ul>
    </div>
</div>

<script>
    // Function to handle recipe generation and display
    document.getElementById('generate-recipe-btn').addEventListener('click', function () {
        const recipeCount = document.getElementById('recipe-count').value;
        const cuisine = document.getElementById('cuisine-select').value;
        const cookingTime = document.getElementById('cooking-time').value;

        fetch("{% url 'generate_recipe' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                recipe_count: recipeCount,
                cuisine: cuisine,
                cooking_time: cookingTime
            })
        })
        .then(response => response.json())
        .then(data => {
            const recipeList = document.getElementById('recipe-list');
            recipeList.innerHTML = ''; // Clear previous recipes

            if (data.recipes) {
                data.recipes.forEach(recipe => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `
                        <div class="recipe-card">
                            <img src="${recipe.image}" alt="${recipe.title}" class="recipe-img">
                            <div class="recipe-info">
                                <h4>${recipe.title}</h4>
                                <a href="https://spoonacular.com/recipes/${recipe.title.replace(/\s+/g, '-')}-${recipe.id}" target="_blank">View Full Recipe</a>
                                <p><strong>Used Ingredients:</strong> ${recipe.usedIngredients.map(i => i.name).join(', ')}</p>
                                <p><strong>Missing Ingredients:</strong> ${recipe.missedIngredients.map(i => i.name).join(', ')}</p>
                                <button class="btn btn-primary mt-2 add-to-calendar-btn" 
                                        data-title="${recipe.title}" 
                                        data-image="${recipe.image}" 
                                        data-id="${recipe.id}">
                                    Add to Calendar
                                </button>
                            </div>
                        </div>
                    `;
                    recipeList.appendChild(li);
                });

                // Add event listeners for "Add to Calendar" buttons
                document.querySelectorAll('.add-to-calendar-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const recipeTitle = this.dataset.title;
                        const recipeImage = this.dataset.image;
                        const recipeId = this.dataset.id;

                        const date = prompt(`Enter the date to schedule "${recipeTitle}" (YYYY-MM-DD):`);
                        if (!date) return;

                        const mealType = prompt('Is this for lunch or dinner? (Type "lunch" or "dinner")').toLowerCase();
                        if (!['lunch', 'dinner'].includes(mealType)) {
                            alert('Invalid meal type. Please type "lunch" or "dinner".');
                            return;
                        }

                        addToCalendar(recipeTitle, recipeImage, recipeId, date, mealType);
                    });
                });
            } else {
                recipeList.innerHTML = '<li class="list-group-item">No recipes found.</li>';
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Function to add a recipe to the calendar
    function addToCalendar(title, image, recipeId, date, mealType) {
        fetch("{% url 'add_to_calendar' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                title: title,
                image: image,
                recipe_id: recipeId,
                date: date,
                meal_type: mealType // Include meal type (lunch or dinner)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert(`"${title}" has been added to your calendar on ${date} for ${mealType}.`);
            } else {
                alert("Failed to add to calendar.");
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>

<style>
    .recipe-card {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .recipe-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
    }
    .recipe-info {
        flex: 1;
    }
    .recipe-info h4 {
        margin: 0;
    }
    .recipe-info a {
        text-decoration: none;
        color: #007bff;
    }
</style>
{% endblock %}
