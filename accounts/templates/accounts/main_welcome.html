{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1>Welcome, {{ user.username }}!</h1>
    <p>Enter your pantry items and utensils:</p>

    <!-- Pantry Section -->
    <h3>Your Pantry</h3>
    <div class="mb-3">
        <label for="pantry" class="form-label">Add Pantry Item</label>
        <input type="text" class="form-control" id="pantry" placeholder="Enter pantry item name">
        <input type="number" class="form-control mt-2" id="pantry_quantity" placeholder="Quantity" value="1">
    </div>
    <ul id="pantry-list" class="list-group">
        {% for item in pantry_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                {{ item.item_name }} ({{ item.quantity }})
                <button class="btn btn-danger btn-sm" onclick="deletePantryItem({{ item.id }})">Delete</button>
            </li>
        {% empty %}
            <li class="list-group-item" id="no-pantry">No pantry items added.</li>
        {% endfor %}
    </ul>

    <!-- Utensil Section -->
    <h3 class="mt-4">Your Utensils</h3>
    <div class="mb-3">
        <label for="utensil" class="form-label">Add Utensil</label>
        <input type="text" class="form-control" id="utensil" placeholder="Enter utensil name">
        <input type="number" class="form-control mt-2" id="utensil_quantity" placeholder="Quantity" value="1">
    </div>
    <ul id="utensil-list" class="list-group">
        {% for utensil in utensil_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ utensil.id }}">
                {{ utensil.utensil_name }} ({{ utensil.quantity }})
                <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem({{ utensil.id }})">Delete</button>
            </li>
        {% empty %}
            <li class="list-group-item" id="no-utensils">No utensils added.</li>
        {% endfor %}
    </ul>

    <!-- Recipe Count Input Field -->
    <div class="mt-5 mb-3">
        <h3 class="form-label">Number of Recipe Suggestions</h3>
        <input type="number" class="form-control" id="recipe-count" placeholder="Enter number (e.g., 5)" min="1" max="10" value="5">
    </div>

    <!-- Cuisine Dropdown -->
    <div class="mb-3">
        <label for="cuisine-select" class="form-label"><strong>Select a Cuisine</strong></label>
        <select class="form-select" id="cuisine-select">
            <option value="">-- Select Cuisine --</option>
            <option value="African">African</option>
            <option value="American">American</option>
            <option value="British">British</option>
            <option value="Cajun">Cajun</option>
            <option value="Caribbean">Caribbean</option>
            <option value="Chinese">Chinese</option>
            <option value="Eastern European">Eastern European</option>
            <option value="European">European</option>
            <option value="French">French</option>
            <option value="German">German</option>
            <option value="Greek">Greek</option>
            <option value="Indian">Indian</option>
            <option value="Irish">Irish</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Jewish">Jewish</option>
            <option value="Korean">Korean</option>
            <option value="Latin American">Latin American</option>
            <option value="Mediterranean">Mediterranean</option>
            <option value="Mexican">Mexican</option>
            <option value="Middle Eastern">Middle Eastern</option>
            <option value="Nordic">Nordic</option>
            <option value="Southern">Southern</option>
            <option value="Spanish">Spanish</option>
            <option value="Thai">Thai</option>
            <option value="Vietnamese">Vietnamese</option>
        </select>
    </div>

    <!-- Recipe Generation Button -->
    <button class="btn btn-primary mt-4" id="generate-recipe-btn">Generate Recipe</button>

    <!-- Display Generated Recipes -->
    <div id="recipe-display" class="mt-4">
        <h3>Suggested Recipes</h3>
        <ul id="recipe-list" class="list-group"></ul>
    </div>
</div>

<script>
    // Function to handle adding a pantry item with AJAX and dynamically updating the DOM
    document.getElementById('pantry').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const itemName = event.target.value;
            const quantity = document.getElementById('pantry_quantity').value;
            fetch("{% url 'add_pantry_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `item_name=${itemName}&quantity=${quantity}`
            }).then(response => response.json()).then(data => {
                if (data.status === "success") {
                    const pantryList = document.getElementById('pantry-list');
                    
                    // Remove "No pantry items added" message if it exists
                    const noPantryMessage = document.getElementById('no-pantry');
                    if (noPantryMessage) noPantryMessage.remove();

                    // Add the new item to the DOM
                    const newItem = document.createElement('li');
                    newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    newItem.setAttribute('data-id', data.item_id);
                    newItem.innerHTML = `${data.item} (${data.quantity})
                        <button class="btn btn-danger btn-sm" onclick="deletePantryItem(${data.item_id})">Delete</button>`;
                    pantryList.appendChild(newItem);
                }
            });
            event.target.value = '';  // Clear the input field
        }
    });

    // Function to handle adding a utensil item with AJAX and dynamically updating the DOM
    document.getElementById('utensil').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const utensilName = event.target.value;
            const quantity = document.getElementById('utensil_quantity').value;
            fetch("{% url 'add_utensil_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `utensil_name=${utensilName}&quantity=${quantity}`
            }).then(response => response.json()).then(data => {
                if (data.status === "success") {
                    const utensilList = document.getElementById('utensil-list');

                    // Remove "No utensils added" message if it exists
                    const noUtensilsMessage = document.getElementById('no-utensils');
                    if (noUtensilsMessage) noUtensilsMessage.remove();

                    // Add the new utensil to the DOM
                    const newUtensil = document.createElement('li');
                    newUtensil.className = 'list-group-item d-flex justify-content-between align-items-center';
                    newUtensil.setAttribute('data-id', data.utensil_id);
                    newUtensil.innerHTML = `${data.utensil} (${data.quantity})
                        <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem(${data.utensil_id})">Delete</button>`;
                    utensilList.appendChild(newUtensil);
                }
            });
            event.target.value = '';  // Clear the input field
        }
    });

    // Function to handle deleting a pantry item with AJAX and dynamically updating the DOM
    function deletePantryItem(itemId) {
        fetch("{% url 'delete_pantry_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `item_id=${itemId}`
        }).then(response => response.json()).then(data => {
            if (data.status === "success") {
                // Remove the item from the DOM
                document.querySelector(`#pantry-list li[data-id="${itemId}"]`).remove();
                
                // If no items left, show "No pantry items added" message
                if (!document.querySelector('#pantry-list li')) {
                    const noPantryMessage = document.createElement('li');
                    noPantryMessage.className = 'list-group-item';
                    noPantryMessage.id = 'no-pantry';
                    noPantryMessage.innerText = 'No pantry items added.';
                    document.getElementById('pantry-list').appendChild(noPantryMessage);
                }
            }
        });
    }

    // Function to handle deleting a utensil item with AJAX and dynamically updating the DOM
    function deleteUtensilItem(itemId) {
        fetch("{% url 'delete_utensil_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `item_id=${itemId}`
        }).then(response => response.json()).then(data => {
            if (data.status === "success") {
                // Remove the utensil from the DOM
                document.querySelector(`#utensil-list li[data-id="${itemId}"]`).remove();
                
                // If no items left, show "No utensils added" message
                if (!document.querySelector('#utensil-list li')) {
                    const noUtensilsMessage = document.createElement('li');
                    noUtensilsMessage.className = 'list-group-item';
                    noUtensilsMessage.id = 'no-utensils';
                    noUtensilsMessage.innerText = 'No utensils added.';
                    document.getElementById('utensil-list').appendChild(noUtensilsMessage);
                }
            }
        });
    }
    document.getElementById('generate-recipe-btn').addEventListener('click', function () {
        const recipeCount = document.getElementById('recipe-count').value;
        const cuisine = document.getElementById('cuisine-select').value; // Empty if not selected

        fetch("{% url 'generate_recipe' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                recipe_count: recipeCount,
                cuisine: cuisine // Will be an empty string if no cuisine is selected
            })
        })
            .then(response => response.json())
            .then(data => {
                const recipeList = document.getElementById('recipe-list');
                recipeList.innerHTML = ''; // Clear the list

                if (data.recipes) {
                    data.recipes.forEach(recipe => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `
                            <div class="recipe-card">
                                <img src="${recipe.image}" alt="${recipe.title}" class="recipe-img">
                                <div class="recipe-info">
                                    <h4>${recipe.title}</h4>
                                    <a href="https://spoonacular.com/recipes/${recipe.title.replace(/\s+/g, '-')}-${recipe.id}" target="_blank">View Full Recipe</a>
                                    <p><strong>Used Ingredients:</strong> ${recipe.usedIngredients.map(i => i.name).join(', ')}</p>
                                    <p><strong>Missing Ingredients:</strong> ${recipe.missedIngredients.map(i => i.name).join(', ')}</p>
                                </div>
                            </div>
                        `;
                        recipeList.appendChild(li);
                    });
                } else {
                    recipeList.innerHTML = '<li class="list-group-item">No recipes found.</li>';
                }
            })
            .catch(error => console.error('Error:', error));
    });
</script>

<style>
    .recipe-card {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .recipe-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
    }
    .recipe-info {
        flex: 1;
    }
    .recipe-info h4 {
        margin: 0;
    }
    .recipe-info a {
        text-decoration: none;
        color: #007bff;
    }
</style>

{% endblock %}
