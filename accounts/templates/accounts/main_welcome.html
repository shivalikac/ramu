{% extends 'base.html' %}
<!-- Extends the base template to include shared elements -->

{% block content %}
<div class="container mt-5">
    <!-- Welcome message with user's username -->
    <h1 class="mb-5">Welcome, {{ user.username }}!</h1>

    <!-- Pantry Section -->
    <div class="mb-5">
        <h3 class="mb-3">Your Pantry</h3>
        <!-- Input fields to add a pantry item -->
        <div class="mb-3">
            <label for="pantry" class="form-label">Add Pantry Item</label>
            <input type="text" class="form-control" id="pantry" placeholder="Enter pantry item name">
            <input type="number" class="form-control mt-2" id="pantry_quantity" placeholder="Quantity" value="1">
        </div>
        <!-- List of pantry items -->
        <ul id="pantry-list" class="list-group">
            {% for item in pantry_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                    {{ item.item_name }} ({{ item.quantity }})
                    <button class="btn btn-danger btn-sm" onclick="deletePantryItem({{ item.id }})">Delete</button>
                </li>
            {% empty %}
                <li class="list-group-item text-muted" id="no-pantry">No pantry items added yet.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Utensil Section -->
    <div class="mb-5">
        <h3 class="mb-3">Your Utensils</h3>
        <!-- Input fields to add a utensil -->
        <div class="mb-3">
            <label for="utensil" class="form-label">Add Utensil</label>
            <input type="text" class="form-control" id="utensil" placeholder="Enter utensil name">
            <input type="number" class="form-control mt-2" id="utensil_quantity" placeholder="Quantity" value="1">
        </div>
        <!-- List of utensils -->
        <ul id="utensil-list" class="list-group">
            {% for utensil in utensil_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ utensil.id }}">
                    {{ utensil.utensil_name }} ({{ utensil.quantity }})
                    <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem({{ utensil.id }})">Delete</button>
                </li>
            {% empty %}
                <li class="list-group-item text-muted" id="no-utensils">No utensils added yet.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Recipe Filters -->
    <div class="mb-5">
        <h3 class="mb-3">Filters for Recipes</h3>
        <!-- Input for cooking time -->
        <div class="mb-3">
            <label for="cooking-time" class="form-label">Maximum Cooking Time (in minutes)</label>
            <input type="number" class="form-control" id="cooking-time" placeholder="Enter time (e.g., 30)" min="1">
        </div>
        <!-- Input for the number of recipes -->
        <div class="mb-3">
            <label for="recipe-count" class="form-label">Number of Recipe Suggestions</label>
            <input type="number" class="form-control" id="recipe-count" value="5" min="1" max="10">
        </div>
        <!-- Dropdown for cuisine selection -->
        <div class="mb-3">
            <label for="cuisine-select" class="form-label">Select a Cuisine</label>
            <select class="form-select" id="cuisine-select">
                <option value="">-- Select Cuisine --</option>
                <option value="African">African</option>
                <option value="American">American</option>
                <option value="British">British</option>
                <option value="Cajun">Cajun</option>
                <option value="Caribbean">Caribbean</option>
                <option value="Chinese">Chinese</option>
                <option value="Eastern European">Eastern European</option>
                <option value="European">European</option>
                <option value="French">French</option>
                <option value="German">German</option>
                <option value="Greek">Greek</option>
                <option value="Indian">Indian</option>
                <option value="Irish">Irish</option>
                <option value="Italian">Italian</option>
                <option value="Japanese">Japanese</option>
                <option value="Jewish">Jewish</option>
                <option value="Korean">Korean</option>
                <option value="Latin American">Latin American</option>
                <option value="Mediterranean">Mediterranean</option>
                <option value="Mexican">Mexican</option>
                <option value="Middle Eastern">Middle Eastern</option>
                <option value="Nordic">Nordic</option>
                <option value="Southern">Southern</option>
                <option value="Spanish">Spanish</option>
                <option value="Thai">Thai</option>
                <option value="Vietnamese">Vietnamese</option>
            </select>
        </div>
        <!-- Multi-select for dietary intolerances -->
        <div class="mb-3">
            <label for="intolerances-select" class="form-label">Select Intolerances</label>
            <select class="form-select" id="intolerances-select" multiple>
                <option value="dairy">Dairy</option>
                <option value="egg">Egg</option>
                <option value="gluten">Gluten</option>
                <option value="grain">Grain</option>
                <option value="peanut">Peanut</option>
                <option value="seafood">Seafood</option>
                <option value="sesame">Sesame</option>
                <option value="shellfish">Shellfish</option>
                <option value="soy">Soy</option>
                <option value="sulfite">Sulfite</option>
                <option value="tree nut">Tree Nut</option>
                <option value="wheat">Wheat</option>
            </select>
            <small class="form-text text-muted">
                Hold Ctrl (Windows) / Command (Mac) to select multiple options.
            </small>
        </div>
    </div>

    <!-- Generate Recipe Button -->
    <button class="btn btn-lg btn-primary my-3 px-4 py-3" id="generate-recipe-btn">Generate Recipe!</button>

    <!-- Recipe Suggestions Section -->
    <div id="recipe-display" class="mt-5">
        <h3 class="mb-3">Suggested Recipes</h3>
        <ul id="recipe-list" class="list-group"></ul>
    </div>
</div>

<!-- Modal for Adding Recipe to Calendar -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Add Recipe to Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- Input for selecting a date -->
                    <div class="mb-3">
                        <label for="calendar-date" class="form-label">Select a Date</label>
                        <input type="date" class="form-control" id="calendar-date">
                    </div>
                    <!-- Dropdown for selecting meal type -->
                    <div class="mb-3">
                        <label for="meal-type" class="form-label">Meal Type</label>
                        <select class="form-select" id="meal-type">
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-calendar-btn">Add to Calendar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('generate-recipe-btn').addEventListener('click', function () {
        // Fetch user input values for the recipe generation
        const recipeCount = document.getElementById('recipe-count').value; 
        const cuisine = document.getElementById('cuisine-select').value; 
        const cookingTime = document.getElementById('cooking-time').value; 

        // Fetch selected dietary intolerances
        const intolerancesSelect = document.getElementById('intolerances-select');
        const intolerances = Array.from(intolerancesSelect.selectedOptions).map(option => option.value);

        // Send a POST request to the backend to generate recipes
        fetch("{% url 'generate_recipe' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({
                recipe_count: recipeCount,
                cuisine: cuisine,
                cooking_time: cookingTime,
                intolerances: intolerances
            })
        })
        .then(response => response.json())
        .then(data => {
            const recipeList = document.getElementById('recipe-list'); 
            recipeList.innerHTML = ''; 

            if (data.recipes) {
                // Loop through the fetched recipes and display them in the list
                data.recipes.forEach(recipe => {
                    const li = document.createElement('li'); // Create a new list item
                    li.className = 'list-group-item';
                    li.innerHTML = `
                        <div class="recipe-card">
                            <img src="${recipe.image}" alt="${recipe.title}" class="recipe-img"> <!-- Recipe image -->
                            <div class="recipe-info">
                                <h3>${recipe.title}</h3> <!-- Recipe title -->
                                <a href="https://spoonacular.com/recipes/${recipe.title.replace(/\s+/g, '-')}-${recipe.id}" target="_blank">View Full Recipe</a> <!-- Link to full recipe -->
                                <p><strong>Used Ingredients:</strong> ${recipe.usedIngredients.map(i => i.name).join(', ')}</p>
                                <!-- List of used ingredients -->
                                <p><strong>Missing Ingredients:</strong> ${recipe.missedIngredients.map(i => i.name).join(', ')}</p>
                                <!-- List of missing ingredients -->
                                <button class="btn btn-primary mt-2 add-to-calendar-btn" 
                                    data-title="${recipe.title}" data-image="${recipe.image}" data-id="${recipe.id}">
                                    Add to Calendar
                                </button> <!-- Button to add the recipe to the calendar -->
                            </div>
                        </div>
                    `;
                    recipeList.appendChild(li); // Append the recipe to the list
                });

                // Attach event listeners to all "Add to Calendar" buttons
                document.querySelectorAll('.add-to-calendar-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const recipeTitle = this.dataset.title; 
                        const recipeImage = this.dataset.image; 
                        const recipeId = this.dataset.id;

                        // Show the modal for selecting date and meal type
                        const calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
                        calendarModal.show();

                        // Handle the logic for saving the recipe to the calendar
                        document.getElementById('save-calendar-btn').onclick = function () {
                            const date = document.getElementById('calendar-date').value;
                            const mealType = document.getElementById('meal-type').value; 

                            if (!date || !mealType) {
                                alert("Please select a valid date and meal type.");
                                return;
                            }

                            addToCalendar(recipeTitle, recipeImage, recipeId, date, mealType); 
                            calendarModal.hide(); 
                        };
                    });
                });
            } else {
                // Display a message if no recipes are found
                recipeList.innerHTML = '<li class="list-group-item">No recipes found.</li>';
            }
        })
        .catch(error => console.error('Error:', error)); 
    });

    document.getElementById('utensil').addEventListener('keypress', function (event) {
        // Listen for the 'Enter' key press
        if (event.key === 'Enter') {
            event.preventDefault(); 

            // Fetch and trim the utensil name input
            const utensilName = event.target.value.trim(); 
            const quantity = document.getElementById('utensil_quantity').value; 

            // Validate that both utensil name and quantity are provided
            if (!utensilName || !quantity) {
                alert("Both utensil name and quantity are required."); 
                return;
            }

            // Send a POST request to the backend to add the utensil item
            fetch("{% url 'add_utensil_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                body: JSON.stringify({ utensil_name: utensilName, quantity: parseInt(quantity) })
            })
            .then(response => response.json()) 
            .then(data => {
                if (data.status === "success") {
                    // Successfully added the utensil, update the DOM
                    const utensilList = document.getElementById('utensil-list'); 

                    // Remove the "No utensils added" message if it exists
                    const noUtensilMessage = document.getElementById('no-utensils');
                    if (noUtensilMessage) noUtensilMessage.remove();

                    // Create a new list item for the added utensil
                    const newItem = document.createElement('li');
                    newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    newItem.setAttribute('data-id', data.utensil_id); 
                    newItem.innerHTML = `
                        ${data.utensil} (${data.quantity})
                        <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem(${data.utensil_id})">Delete</button>
                    `; // Add utensil details and a delete button
                    utensilList.appendChild(newItem); 

                    // Clear the input fields
                    event.target.value = ''; 
                    document.getElementById('utensil_quantity').value = '1'; 
                } else {
                    // Show an error message if the request failed
                    alert(data.message || "Error adding utensil.");
                }
            })
            .catch(error => console.error('Error:', error)); 
        }
    });

    document.getElementById('pantry').addEventListener('keypress', function (event) {
        // Listen for the 'Enter' key press in the pantry input field
        if (event.key === 'Enter') {
            event.preventDefault(); 

            // Fetch and trim the pantry item name input
            const itemName = event.target.value.trim(); 
            const quantity = document.getElementById('pantry_quantity').value; 

            // Validate that both pantry item name and quantity are provided
            if (!itemName || !quantity) {
                alert("Both item name and quantity are required."); 
                return;
            }

            // Send a POST request to the backend to add the pantry item
            fetch("{% url 'add_pantry_item' %}", {
                method: 'POST', // HTTP POST method
                headers: {
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ item_name: itemName, quantity: parseInt(quantity) }) 
            })
            .then(response => response.json()) 
            .then(data => {
                if (data.status === "success") {
                    // Successfully added the pantry item, update the DOM
                    const pantryList = document.getElementById('pantry-list'); 

                    // Remove the "No pantry items added" message if it exists
                    const noPantryMessage = document.getElementById('no-pantry');
                    if (noPantryMessage) noPantryMessage.remove();

                    // Create a new list item for the added pantry item
                    const newItem = document.createElement('li');
                    newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    newItem.setAttribute('data-id', data.item_id); 
                    newItem.innerHTML = `
                        ${data.item} (${data.quantity})
                        <button class="btn btn-danger btn-sm" onclick="deletePantryItem(${data.item_id})">Delete</button>
                    `; // Add item details and a delete button
                    pantryList.appendChild(newItem);

                    // Clear the input fields
                    event.target.value = '';
                    document.getElementById('pantry_quantity').value = '1'; 
                } else {
                    // Show an error message if the request failed
                    alert(data.message || "Error adding item.");
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    function deletePantryItem(itemId) {
        // Ensure the item ID is provided
        if (!itemId) {
            alert("Item ID is missing. Unable to delete the item.");
            return;
        }

        // Send a POST request to delete the pantry item
        fetch("{% url 'delete_pantry_item' %}", {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ item_id: itemId }) 
        })
        .then(response => response.json()) 
        .then(data => {
            if (data.status === "success") {
                // Remove the pantry item from the DOM
                const itemElement = document.querySelector(`#pantry-list li[data-id="${itemId}"]`);
                if (itemElement) itemElement.remove();

                // If no items remain, display a "No items" message
                if (!document.querySelector('#pantry-list li')) {
                    const noPantryMessage = document.createElement('li');
                    noPantryMessage.className = 'list-group-item';
                    noPantryMessage.id = 'no-pantry';
                    noPantryMessage.innerText = 'No pantry items added.';
                    document.getElementById('pantry-list').appendChild(noPantryMessage);
                }
            } else {
                // Display an error message if deletion fails
                alert(data.message || "Error deleting item.");
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function deleteUtensilItem(itemId) {
        // Ensure the utensil ID is provided
        if (!itemId) {
            alert("Item ID is missing. Unable to delete the utensil.");
            return;
        }

        // Send a POST request to delete the utensil
        fetch("{% url 'delete_utensil_item' %}", {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ item_id: itemId }) 
        })
        .then(response => response.json()) 
        .then(data => {
            if (data.status === "success") {
                // Remove the utensil from the DOM
                const utensilElement = document.querySelector(`#utensil-list li[data-id="${itemId}"]`);
                if (utensilElement) utensilElement.remove();

                // If no utensils remain, display a "No utensils" message
                if (!document.querySelector('#utensil-list li')) {
                    const noUtensilMessage = document.createElement('li');
                    noUtensilMessage.className = 'list-group-item';
                    noUtensilMessage.id = 'no-utensils';
                    noUtensilMessage.innerText = 'No utensils added yet.';
                    document.getElementById('utensil-list').appendChild(noUtensilMessage);
                }
            } else {
                // Display an error message if deletion fails
                alert(data.message || "Error deleting utensil.");
            }
        })
        .catch(error => console.error('Error:', error)); 
    }

    // Add Recipe to Calendar Function
    function addToCalendar(title, image, recipeId, date, mealType) {
        // Send a POST request to add the recipe to the calendar
        fetch("{% url 'add_to_calendar' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ title, image, recipe_id: recipeId, date, meal_type: mealType })
        })
        .then(response => response.json()) 
        .then(data => {
            if (data.status === "success") {
                // Notify the user of the successful addition
                alert(`"${title}" added to your calendar on ${date} for ${mealType}.`);
            } else {
                // Display an error message if the addition fails
                alert("Error: Unable to add to calendar.");
            }
        })
        .catch(error => console.error('Error:', error));
    }

</script>

<style>
    .recipe-card {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .recipe-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
    }
    /* Allow the recipe information to take up remaining space in the flex container */
    .recipe-info {
        flex: 1;
    }
    .recipe-info h3 { 
        font-size: 1.5rem;
        margin: 0;
    }
    .recipe-info a {
        text-decoration: none;
        color: #007bff;
    }
    body {
        font-family: 'Lato', sans-serif; 
    }
    button, input, select, textarea {
        font-family: 'Lato', sans-serif; 
    }
</style>
{% endblock %}
