{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-5">Welcome, {{ user.username }}!</h1>

    <!-- Pantry Section -->
    <div class="mb-5">
        <h3 class="mb-3">Your Pantry</h3>
        <div class="mb-3">
            <label for="pantry" class="form-label">Add Pantry Item</label>
            <input type="text" class="form-control" id="pantry" placeholder="Enter pantry item name">
            <input type="number" class="form-control mt-2" id="pantry_quantity" placeholder="Quantity" value="1">
        </div>
        <ul id="pantry-list" class="list-group">
            {% for item in pantry_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                    {{ item.item_name }} ({{ item.quantity }})
                    <button class="btn btn-danger btn-sm" onclick="deletePantryItem({{ item.id }})">Delete</button>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No pantry items added yet.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Utensil Section -->
    <div class="mb-5">
        <h3 class="mb-3">Your Utensils</h3>
        <div class="mb-3">
            <label for="utensil" class="form-label">Add Utensil</label>
            <input type="text" class="form-control" id="utensil" placeholder="Enter utensil name">
            <input type="number" class="form-control mt-2" id="utensil_quantity" placeholder="Quantity" value="1">
        </div>
        <ul id="utensil-list" class="list-group">
            {% for utensil in utensil_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ utensil.id }}">
                    {{ utensil.utensil_name }} ({{ utensil.quantity }})
                    <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem({{ utensil.id }})">Delete</button>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No utensils added yet.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Filters for Recipes -->
    <div class="mb-5">
        <h3 class="mb-3">Filters for Recipes</h3>
        <div class="mb-3">
            <label for="cooking-time" class="form-label">Maximum Cooking Time (in minutes)</label>
            <input type="number" class="form-control" id="cooking-time" placeholder="Enter time (e.g., 30)" min="1">
        </div>
        <div class="mb-3">
            <label for="recipe-count" class="form-label">Number of Recipe Suggestions</label>
            <input type="number" class="form-control" id="recipe-count" value="5" min="1" max="10">
        </div>
        <div class="mb-3">
            <label for="cuisine-select" class="form-label">Select a Cuisine</label>
            <select class="form-select" id="cuisine-select">
                <option value="">-- Select Cuisine --</option>
                <option value="African">African</option>
                <option value="American">American</option>
                <option value="British">British</option>
                <option value="Cajun">Cajun</option>
                <option value="Caribbean">Caribbean</option>
                <option value="Chinese">Chinese</option>
                <option value="Eastern European">Eastern European</option>
                <option value="European">European</option>
                <option value="French">French</option>
                <option value="German">German</option>
                <option value="Greek">Greek</option>
                <option value="Indian">Indian</option>
                <option value="Irish">Irish</option>
                <option value="Italian">Italian</option>
                <option value="Japanese">Japanese</option>
                <option value="Jewish">Jewish</option>
                <option value="Korean">Korean</option>
                <option value="Latin American">Latin American</option>
                <option value="Mediterranean">Mediterranean</option>
                <option value="Mexican">Mexican</option>
                <option value="Middle Eastern">Middle Eastern</option>
                <option value="Nordic">Nordic</option>
                <option value="Southern">Southern</option>
                <option value="Spanish">Spanish</option>
                <option value="Thai">Thai</option>
                <option value="Vietnamese">Vietnamese</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="intolerances-select" class="form-label"><strong>Select Intolerances</strong></label>
            <select class="form-select" id="intolerances-select" multiple>
                <option value="dairy">Dairy</option>
                <option value="egg">Egg</option>
                <option value="gluten">Gluten</option>
                <option value="grain">Grain</option>
                <option value="peanut">Peanut</option>
                <option value="seafood">Seafood</option>
                <option value="sesame">Sesame</option>
                <option value="shellfish">Shellfish</option>
                <option value="soy">Soy</option>
                <option value="sulfite">Sulfite</option>
                <option value="tree nut">Tree Nut</option>
                <option value="wheat">Wheat</option>
            </select>
            <small class="form-text text-muted">
                Hold down the Ctrl (Windows) / Command (Mac) key to select multiple options.
            </small>
        </div>
    </div>

    <!-- Generate Recipe Button -->
    <button class="btn btn-lg btn-primary my-3 px-4 py-3" id="generate-recipe-btn">Generate Recipe!</button>

    <!-- Recipe Display -->
    <div id="recipe-display" class="mt-5">
        <h3 class="mb-3">Suggested Recipes</h3>
        <ul id="recipe-list" class="list-group"></ul>
    </div>
</div>


<!-- Modal for Adding Recipe to Calendar -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Add Recipe to Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="calendar-date" class="form-label">Select a Date</label>
                        <input type="date" class="form-control" id="calendar-date">
                    </div>
                    <div class="mb-3">
                        <label for="meal-type" class="form-label">Meal Type</label>
                        <select class="form-select" id="meal-type">
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-calendar-btn">Add to Calendar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to handle recipe generation and display
    document.getElementById('generate-recipe-btn').addEventListener('click', function () {
        const recipeCount = document.getElementById('recipe-count').value;
        const cuisine = document.getElementById('cuisine-select').value;
        const cookingTime = document.getElementById('cooking-time').value;

        // Get selected intolerances
        const intolerancesSelect = document.getElementById('intolerances-select');
        const intolerances = Array.from(intolerancesSelect.selectedOptions).map(option => option.value);

        fetch("{% url 'generate_recipe' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                recipe_count: recipeCount,
                cuisine: cuisine,
                cooking_time: cookingTime,
                intolerances: intolerances // Pass intolerances to the backend
            })
        })
        .then(response => response.json())
        .then(data => {
            const recipeList = document.getElementById('recipe-list');
            recipeList.innerHTML = ''; // Clear the list

            if (data.recipes) {
                data.recipes.forEach(recipe => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `
                        <div class="recipe-card">
                            <img src="${recipe.image}" alt="${recipe.title}" class="recipe-img">
                            <div class="recipe-info">
                                <h3>${recipe.title}</h3>
                                <a href="https://spoonacular.com/recipes/${recipe.title.replace(/\s+/g, '-')}-${recipe.id}" target="_blank">View Full Recipe</a>
                                <p><strong>Used Ingredients:</strong> ${recipe.usedIngredients.map(i => i.name).join(', ')}</p>
                                <p><strong>Missing Ingredients:</strong> ${recipe.missedIngredients.map(i => i.name).join(', ')}</p>
                                <button class="btn btn-primary mt-2 add-to-calendar-btn" data-title="${recipe.title}" data-image="${recipe.image}" data-id="${recipe.id}">
                                    Add to Calendar
                                </button>
                            </div>
                        </div>
                    `;
                    recipeList.appendChild(li);
                });

                // Event Listener for "Add to Calendar" Buttons
                document.querySelectorAll('.add-to-calendar-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const recipeTitle = this.dataset.title;
                        const recipeImage = this.dataset.image;
                        const recipeId = this.dataset.id;

                        // Show Modal for Date and Meal Type Selection
                        const calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
                        calendarModal.show();

                        // Handle Save to Calendar Logic
                        document.getElementById('save-calendar-btn').onclick = function () {
                            const date = document.getElementById('calendar-date').value;
                            const mealType = document.getElementById('meal-type').value;

                            if (!date || !mealType) {
                                alert("Please select a valid date and meal type.");
                                return;
                            }

                            addToCalendar(recipeTitle, recipeImage, recipeId, date, mealType);
                            calendarModal.hide();
                        };
                    });
                });
            } else {
                recipeList.innerHTML = '<li class="list-group-item">No recipes found.</li>';
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('utensil').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();

            const utensilName = event.target.value.trim(); // Get the input and trim whitespace
            const quantity = document.getElementById('utensil_quantity').value;

            if (!utensilName || !quantity) {
                alert("Both utensil name and quantity are required.");
                return;
            }

            fetch("{% url 'add_utensil_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ utensil_name: utensilName, quantity: parseInt(quantity) }) // Send utensil name and quantity
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        // Add the new item to the DOM
                        const utensilList = document.getElementById('utensil-list');

                        // Remove "No utensils added" message if it exists
                        const noUtensilMessage = document.getElementById('no-utensils');
                        if (noUtensilMessage) noUtensilMessage.remove();

                        const newItem = document.createElement('li');
                        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        newItem.setAttribute('data-id', data.utensil_id);
                        newItem.innerHTML = `${data.utensil} (${data.quantity})
                            <button class="btn btn-danger btn-sm" onclick="deleteUtensilItem(${data.utensil_id})">Delete</button>`;
                        utensilList.appendChild(newItem);

                        // Clear the input fields
                        event.target.value = '';
                        document.getElementById('utensil_quantity').value = '1';
                    } else {
                        alert(data.message || "Error adding utensil.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    });



    
    document.getElementById('pantry').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();

            const itemName = event.target.value.trim(); // Get the input and trim whitespace
            const quantity = document.getElementById('pantry_quantity').value;

            if (!itemName || !quantity) {
                alert("Both item name and quantity are required.");
                return;
            }

            fetch("{% url 'add_pantry_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ item_name: itemName, quantity: parseInt(quantity) }) // Send item name and quantity
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        // Add the new item to the DOM
                        const pantryList = document.getElementById('pantry-list');

                        // Remove "No pantry items added" message if it exists
                        const noPantryMessage = document.getElementById('no-pantry');
                        if (noPantryMessage) noPantryMessage.remove();

                        const newItem = document.createElement('li');
                        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        newItem.setAttribute('data-id', data.item_id);
                        newItem.innerHTML = `${data.item} (${data.quantity})
                            <button class="btn btn-danger btn-sm" onclick="deletePantryItem(${data.item_id})">Delete</button>`;
                        pantryList.appendChild(newItem);

                        // Clear the input fields
                        event.target.value = '';
                        document.getElementById('pantry_quantity').value = '1';
                    } else {
                        alert(data.message || "Error adding item.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    });

    function deletePantryItem(itemId) {
        if (!itemId) {
            alert("Item ID is missing. Unable to delete the item.");
            return;
        }

        fetch("{% url 'delete_pantry_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ item_id: itemId }) // Send the correct ID
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                // Remove the item from the DOM
                const itemElement = document.querySelector(`#pantry-list li[data-id="${itemId}"]`);
                if (itemElement) itemElement.remove();

                // If no items are left, show a message
                if (!document.querySelector('#pantry-list li')) {
                    const noPantryMessage = document.createElement('li');
                    noPantryMessage.className = 'list-group-item';
                    noPantryMessage.id = 'no-pantry';
                    noPantryMessage.innerText = 'No pantry items added.';
                    document.getElementById('pantry-list').appendChild(noPantryMessage);
                }
            } else {
                alert(data.message || "Error deleting item.");
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function deleteUtensilItem(itemId) {
        if (!itemId) {
            alert("Item ID is missing. Unable to delete the utensil.");
            return;
        }

        fetch("{% url 'delete_utensil_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ item_id: itemId }) // Send the correct utensil ID
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                // Remove the utensil from the DOM
                const utensilElement = document.querySelector(`#utensil-list li[data-id="${itemId}"]`);
                if (utensilElement) utensilElement.remove();

                // If no utensils are left, show a message
                if (!document.querySelector('#utensil-list li')) {
                    const noUtensilMessage = document.createElement('li');
                    noUtensilMessage.className = 'list-group-item';
                    noUtensilMessage.id = 'no-utensils';
                    noUtensilMessage.innerText = 'No utensils added yet.';
                    document.getElementById('utensil-list').appendChild(noUtensilMessage);
                }
            } else {
                alert(data.message || "Error deleting utensil.");
            }
        })
        .catch(error => console.error('Error:', error));
    }



    // Add Recipe to Calendar Function
    function addToCalendar(title, image, recipeId, date, mealType) {
        fetch("{% url 'add_to_calendar' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ title, image, recipe_id: recipeId, date, meal_type: mealType })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert(`"${title}" added to your calendar on ${date} for ${mealType}.`);
            } else {
                alert("Error: Unable to add to calendar.");
            }
        })
        .catch(error => console.error('Error:', error));
    }

</script>

<style>
    .recipe-card {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .recipe-img {
        width: 150px; /* Increase width */
        height: 150px; /* Increase height */
        object-fit: cover;
        border-radius: 8px;
    }
    .recipe-info {
        flex: 1;
    }
    .recipe-info h3 { /* Ensure the font size for h3 is visually appropriate */
        font-size: 1.5rem; /* Adjust based on preference */
        margin: 0;
    }
    .recipe-info a {
        text-decoration: none;
        color: #007bff;
    }
    body {
        font-family: 'Lato', sans-serif; 
    }
    button, input, select, textarea {
        font-family: 'Lato', sans-serif; 
    }
</style>
{% endblock %}
